<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fantasy Football Assistant (HTML)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card { @apply bg-white rounded-2xl shadow p-5; }
    .btn { @apply px-4 py-2 rounded-xl shadow text-sm font-semibold; }
    .btn-primary { @apply bg-indigo-600 text-white hover:bg-indigo-700; }
    .btn-secondary { @apply bg-gray-100 hover:bg-gray-200; }
    .pill { @apply text-xs px-2 py-1 rounded-full bg-indigo-50 text-indigo-700; }
    .tbl th { @apply text-left text-xs font-semibold text-gray-500 uppercase; }
    .tbl td { @apply text-sm; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-6xl mx-auto p-6 space-y-6">
    <header class="flex items-start justify-between gap-4">
      <div>
        <h1 class="text-2xl font-bold">Fantasy Football Assistant</h1>
        <p class="text-sm text-slate-600">Optimize lineup • Suggest waivers • Compare trades — all in your browser.</p>
        <p class="text-xs text-slate-500 mt-1">Note: This single-file app doesn’t log into Yahoo directly. Paste/import your roster & free agents below.</p>
      </div>
      <div class="flex gap-2">
        <button id="btnExportReport" class="btn btn-secondary">Download Weekly Report (.md)</button>
        <button id="btnClearAll" class="btn btn-secondary">Clear All</button>
      </div>
    </header>

    <section class="card">
      <h2 class="text-lg font-semibold mb-4">Roster Settings</h2>
      <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-8 gap-3">
        <div><label class="block text-xs text-slate-500">QB</label><input id="slotQB" type="number" min="0" value="1" class="w-full border rounded-lg px-3 py-2"></div>
        <div><label class="block text-xs text-slate-500">RB</label><input id="slotRB" type="number" min="0" value="2" class="w-full border rounded-lg px-3 py-2"></div>
        <div><label class="block text-xs text-slate-500">WR</label><input id="slotWR" type="number" min="0" value="2" class="w-full border rounded-lg px-3 py-2"></div>
        <div><label class="block text-xs text-slate-500">TE</label><input id="slotTE" type="number" min="0" value="1" class="w-full border rounded-lg px-3 py-2"></div>
        <div><label class="block text-xs text-slate-500">FLEX (RB/WR/TE)</label><input id="slotFLEX" type="number" min="0" value="1" class="w-full border rounded-lg px-3 py-2"></div>
        <div><label class="block text-xs text-slate-500">K</label><input id="slotK" type="number" min="0" value="1" class="w-full border rounded-lg px-3 py-2"></div>
        <div><label class="block text-xs text-slate-500">DEF</label><input id="slotDEF" type="number" min="0" value="1" class="w-full border rounded-lg px-3 py-2"></div>
        <div><label class="block text-xs text-slate-500">SUPERFLEX (QB/RB/WR/TE)</label><input id="slotSF" type="number" min="0" value="0" class="w-full border rounded-lg px-3 py-2"></div>
      </div>
    </section>

    <section class="grid md:grid-cols-2 gap-6">
      <div class="card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Your Roster</h2>
          <div class="flex gap-2">
            <input type="file" id="inputRosterFile" accept=".json,.csv" class="hidden">
            <button class="btn btn-secondary" onclick="document.getElementById('inputRosterFile').click()">Import</button>
            <button id="btnAddRoster" class="btn btn-secondary">Add Player</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="tbl w-full">
            <thead>
              <tr><th>Name</th><th>Pos</th><th class="text-right">Proj</th><th></th></tr>
            </thead>
            <tbody id="tbodyRoster"></tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Free Agents</h2>
          <div class="flex gap-2">
            <input type="file" id="inputFAFile" accept=".json,.csv" class="hidden">
            <button class="btn btn-secondary" onclick="document.getElementById('inputFAFile').click()">Import</button>
            <button id="btnAddFA" class="btn btn-secondary">Add Player</button>
          </div>
        </div>
        <div class="overflow-x-auto">
          <table class="tbl w-full">
            <thead>
              <tr><th>Name</th><th>Pos</th><th class="text-right">Proj</th><th></th></tr>
            </thead>
            <tbody id="tbodyFA"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="flex flex-wrap gap-3">
        <button id="btnOptimize" class="btn btn-primary">Optimize Lineup</button>
        <button id="btnWaivers" class="btn btn-primary">Suggest Waivers</button>
        <button id="btnTrade" class="btn btn-primary">Trade Compare</button>
      </div>
      <p class="text-xs text-slate-500 mt-2">Projections are your numbers (e.g., rolling avg, custom model). Add or import values for best results.</p>
    </section>

    <section class="grid md:grid-cols-2 gap-6">
      <div class="card">
        <h3 class="text-base font-semibold mb-3">Optimal Lineup</h3>
        <div id="lineupBox" class="text-sm"></div>
      </div>
      <div class="card">
        <h3 class="text-base font-semibold mb-3">Waiver Suggestions</h3>
        <div id="waiverBox" class="text-sm"></div>
      </div>
    </section>

    <div id="tradeModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-lg p-6 w-full max-w-xl space-y-4">
        <div class="flex items-center justify-between">
          <h3 class="text-lg font-semibold">Trade Compare</h3>
          <button class="btn btn-secondary" onclick="toggleTrade(false)">Close</button>
        </div>
        <p class="text-xs text-slate-600">Enter player names exactly as they appear in your roster table. We’ll compute VOR (value over replacement) from your lineup needs.</p>
        <div class="grid md:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs text-slate-500 mb-1">Players you GIVE (comma-separated)</label>
            <textarea id="tradeGive" class="w-full border rounded-lg p-2 h-32"></textarea>
          </div>
          <div>
            <label class="block text-xs text-slate-500 mb-1">Players you GET (comma-separated)</label>
            <textarea id="tradeGet" class="w-full border rounded-lg p-2 h-32"></textarea>
          </div>
        </div>
        <div class="flex justify-end gap-2">
          <button class="btn btn-primary" onclick="runTrade()">Compare</button>
        </div>
        <pre id="tradeOut" class="mono text-sm bg-slate-50 p-3 rounded-lg overflow-x-auto"></pre>
      </div>
    </div>

    <footer class="text-xs text-slate-500 text-center py-6">
      Built as a single-file tool; no data leaves your browser.
    </footer>
  </div>

  <script>
    const POS = ["QB","RB","WR","TE","K","DEF"];
    const FLEX = new Set(["RB","WR","TE"]);
    const SUPERFLEX = new Set(["QB","RB","WR","TE"]);

    let roster = [];
    let freeAgents = [];

    const tbodyRoster = document.getElementById('tbodyRoster');
    const tbodyFA = document.getElementById('tbodyFA');
    const lineupBox = document.getElementById('lineupBox');
    const waiverBox = document.getElementById('waiverBox');

    const slotInputs = {
      QB: document.getElementById('slotQB'),
      RB: document.getElementById('slotRB'),
      WR: document.getElementById('slotWR'),
      TE: document.getElementById('slotTE'),
      FLEX: document.getElementById('slotFLEX'),
      K: document.getElementById('slotK'),
      DEF: document.getElementById('slotDEF'),
      SF: document.getElementById('slotSF'),
    };

    function uid() { return Math.random().toString(36).slice(2, 9); }
    function readSlots() {
      return {
        QB: +slotInputs.QB.value || 0,
        RB: +slotInputs.RB.value || 0,
        WR: +slotInputs.WR.value || 0,
        TE: +slotInputs.TE.value || 0,
        FLEX: +slotInputs.FLEX.value || 0,
        K: +slotInputs.K.value || 0,
        DEF: +slotInputs.DEF.value || 0,
        SUPERFLEX: +slotInputs.SF.value || 0,
      };
    }
    function renderTable(list, tbody) {
      tbody.innerHTML = "";
      for (const p of list) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input class="w-full border rounded-lg px-2 py-1" value="${p.name}" onchange="onEdit('${p.id}','name',this.value, '${tbody.id}')"></td>
          <td>
            <select class="w-full border rounded-lg px-2 py-1" onchange="onEdit('${p.id}','pos',this.value, '${tbody.id}')">
              ${POS.map(pos => `<option ${p.pos===pos?'selected':''}>${pos}</option>`).join('')}
            </select>
          </td>
          <td class="text-right"><input class="w-24 text-right border rounded-lg px-2 py-1" value="${p.proj}" onchange="onEdit('${p.id}','proj',parseFloat(this.value)||0, '${tbody.id}')"></td>
          <td class="text-right"><button class="btn btn-secondary" onclick="onDelete('${p.id}','${tbody.id}')">Delete</button></td>
        `;
        tbody.appendChild(tr);
      }
    }
    window.onEdit = function(id, field, value, tableId) {
      const arr = tableId==='tbodyRoster' ? roster : freeAgents;
      const idx = arr.findIndex(x=>x.id===id);
      if (idx>-1) { arr[idx][field] = value; render(); }
    };
    window.onDelete = function(id, tableId) {
      const arr = tableId==='tbodyRoster' ? roster : freeAgents;
      const idx = arr.findIndex(x=>x.id===id);
      if (idx>-1) { arr.splice(idx,1); render(); }
    };

    function addPlayer(to='roster') {
      const arr = to==='roster'? roster : freeAgents;
      arr.push({ id: uid(), name: "Player Name", pos: "RB", proj: 0 });
      render();
    }

    function parseFile(file, cb) {
      const reader = new FileReader();
      reader.onload = () => {
        const txt = reader.result;
        try {
          if (file.name.endsWith('.json')) {
            const obj = JSON.parse(txt);
            cb(obj);
          } else if (file.name.endsWith('.csv')) {
            const rows = txt.split(/\\r?\\n/).filter(Boolean).map(r=>r.split(','));
            const header = rows.shift().map(h=>h.trim().toLowerCase());
            const ni = header.indexOf('name'), pi = header.indexOf('pos'), yi = header.indexOf('projection')>-1?header.indexOf('projection'):header.indexOf('proj');
            const arr = rows.map(r=>({ name:r[ni], pos:r[pi], proj: parseFloat(r[yi])||0 }));
            cb(arr);
          } else {
            alert("Unsupported file type. Use .json or .csv");
          }
        } catch(e) {
          console.error(e); alert("Failed to parse file.");
        }
      };
      reader.readAsText(file);
    }

    document.getElementById('inputRosterFile').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if (!f) return;
      parseFile(f, (data)=>{
        let arr = Array.isArray(data)? data : (data.roster || []);
        roster = arr.map(p=>({id:uid(), name:p.name||p.full||p.player||"", pos:(p.pos||p.position||"RB").toUpperCase(), proj: +p.proj||+p.projection||0}));
        render();
      });
      e.target.value = "";
    });
    document.getElementById('inputFAFile').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if (!f) return;
      parseFile(f, (data)=>{
        let arr = Array.isArray(data)? data : (data.free_agents || data.freeAgents || []);
        freeAgents = arr.map(p=>({id:uid(), name:p.name||p.full||p.player||"", pos:(p.pos||p.position||"RB").toUpperCase(), proj: +p.proj||+p.projection||0}));
        render();
      });
      e.target.value = "";
    });

    document.getElementById('btnAddRoster').addEventListener('click', ()=>addPlayer('roster'));
    document.getElementById('btnAddFA').addEventListener('click', ()=>addPlayer('fa'));
    document.getElementById('btnClearAll').addEventListener('click', ()=>{ roster=[]; freeAgents=[]; render(); });

    function optimizeLineup(players, slots) {
      const P = players.slice().sort((a,b)=>b.proj - a.proj);
      const caps = {QB: slots.QB|0, RB: slots.RB|0, WR: slots.WR|0, TE: slots.TE|0, FLEX: slots.FLEX|0, K: slots.K|0, DEF: slots.DEF|0, SUPERFLEX: slots.SUPERFLEX|0};
      let best = { total: -1, chosen: [] };
      const prefix = [0];
      for (let i=0;i<P.length;i++) prefix[i+1] = prefix[i] + P[i].proj;
      const slotsList = ['QB','RB','WR','TE','K','DEF','FLEX','SUPERFLEX'];
      function remaining(c){return c.QB+c.RB+c.WR+c.TE+c.FLEX+c.K+c.DEF+c.SUPERFLEX;}
      function eligible(p, s){
        if (s==='FLEX') return ['RB','WR','TE'].includes(p.pos);
        if (s==='SUPERFLEX') return ['QB','RB','WR','TE'].includes(p.pos);
        return p.pos===s;
      }
      function canFit(p,c){for (const s of slotsList){if(c[s]>0 && eligible(p,s)) return true;} return false;}
      function dfs(i,c,chosen,total){
        const rem = remaining(c);
        if (rem===0){ if (total>best.total) best={total, chosen:chosen.slice()}; return; }
        if (i>=P.length){ if (total>best.total) best={total, chosen:chosen.slice()}; return; }
        const maxPossible = total + (prefix[Math.min(P.length, i+rem)] - prefix[i]);
        if (maxPossible <= best.total - 1e-9) return;
        const p = P[i];
        for (const s of slotsList){
          if (c[s]>0 && eligible(p,s)){
            c[s]--; chosen.push({...p, slot:s});
            dfs(i+1,c,chosen,total+p.proj);
            chosen.pop(); c[s]++;
          }
        }
        if (!canFit(p,c) || (P.length-(i+1) >= rem)) dfs(i+1,c,chosen,total);
      }
      dfs(0, {**caps}, [], 0);
      const order = {QB:1,RB:2,WR:3,TE:4,FLEX:5,SUPERFLEX:6,K:7,DEF:8};
      best.chosen.sort((a,b)=>order[a.slot]-order[b.slot] || b.proj - a.proj);
      const chosenIds = new Set(best.chosen.map(x=>x.id));
      const bench = P.filter(p=>!chosenIds.has(p.id));
      return { starters: best.chosen, bench, total: best.total };
    }

    function suggestWaivers(freeAgents, starters, threshold=0.5, perPos=5) {
      const byPos = {}; starters.forEach(s=>{(byPos[s.pos]=byPos[s.pos]||[]).push(s);});
      const groupedFA = {}; freeAgents.forEach(f=>{(groupedFA[f.pos]=groupedFA[f.pos]||[]).push(f);});
      const out = [];
      for (const pos of Object.keys(groupedFA)) {
        if (pos==='DEF') continue;
        const worst = (byPos[pos]||[]).slice().sort((a,b)=>a.proj-b.proj)[0];
        if (!worst) continue;
        const picks = groupedFA[pos].slice().sort((a,b)=>b.proj-a.proj).slice(0,perPos);
        for (const c of picks) {
          const d = c.proj - worst.proj;
          if (d>threshold) out.push({pos, add:c, drop:worst, delta:+d.toFixed(2)});
        }
      }
      return out.sort((a,b)=>b.delta-a.delta);
    }

    function computeVOR(players, starters) {
      const starterCounts = {}; starters.forEach(s=>starterCounts[s.pos]=(starterCounts[s.pos]||0)+1);
      const byPos = {}; players.forEach(p=>{(byPos[p.pos]=byPos[p.pos]||[]).push(p)});
      const reps = {};
      for (const pos of Object.keys(byPos)) {
        const pool = byPos[pos].slice().sort((a,b)=>b.proj-a.proj);
        const cnt = starterCounts[pos]||0;
        if (cnt>0 && pool.length>=cnt) reps[pos]=pool[cnt-1].proj; else reps[pos]=pool.length?median(pool.map(x=>x.proj)):0;
      }
      const withVOR = players.map(p=>({...p, VOR:+(p.proj-(reps[p.pos]||0)).toFixed(2)}));
      return { withVOR, reps };
    }
    function median(a){const s=a.slice().sort((x,y)=>x-y);const m=Math.floor(s.length/2);return s.length%2?s[m]:(s[m-1]+s[m])/2;}

    function tradeCompare(players, starters, giveNames, getNames) {
      const { withVOR } = computeVOR(players, starters);
      const map = new Map(withVOR.map(p=>[p.name.toLowerCase(), p]));
      const give = giveNames.map(n=>map.get(n.trim().toLowerCase())).filter(Boolean);
      const gett = getNames.map(n=>map.get(n.trim().toLowerCase())).filter(Boolean);
      const sum = xs=>xs.reduce((s,x)=>s+(x?.VOR||0),0);
      return { give, get: gett, give_total_VOR:+sum(give).toFixed(2), get_total_VOR:+sum(gett).toFixed(2), net_VOR:+(sum(gett)-sum(give)).toFixed(2) };
    }

    function render() { renderTable(roster, tbodyRoster); renderTable(freeAgents, tbodyFA); }

    document.getElementById('btnOptimize').addEventListener('click', ()=>{
      const slots = readSlots();
      if (!roster.length) { alert("Add roster players first."); return; }
      const res = optimizeLineup(roster, slots);
      const startersHtml = res.starters.map(s=>`<tr>
          <td class="py-1">${s.slot}</td><td class="py-1">${s.name}</td>
          <td class="py-1">${s.pos}</td><td class="py-1 text-right">${s.proj.toFixed(1)}</td>
        </tr>`).join('');
      const benchHtml = res.bench.slice(0,50).map(b=>`<tr class="text-slate-500">
          <td class="py-1">BN</td><td class="py-1">${b.name}</td>
          <td class="py-1">${b.pos}</td><td class="py-1 text-right">${b.proj.toFixed(1)}</td>
        </tr>`).join('');
      lineupBox.innerHTML = `<table class="w-full tbl">
          <thead><tr><th>SLOT</th><th>PLAYER</th><th>POS</th><th class="text-right">PROJ</th></tr></thead>
          <tbody>${startersHtml}${benchHtml?`<tr><td colspan="4" class="pt-2"><span class="pill">Bench</span></td></tr>${benchHtml}`:''}</tbody>
        </table>`;
    });

    document.getElementById('btnWaivers').addEventListener('click', ()=>{
      const slots = readSlots();
      if (!roster.length) { alert("Add roster players first."); return; }
      const res = optimizeLineup(roster, slots);
      if (!freeAgents.length) { alert("Add/import free agents first."); return; }
      const wa = suggestWaivers(freeAgents, res.starters, 0.5, 5);
      waiverBox.innerHTML = wa.length ? `<table class="w-full tbl">
          <thead><tr><th>POS</th><th>ADD</th><th class="text-right">ADD PROJ</th><th>DROP</th><th class="text-right">DROP PROJ</th><th class="text-right">Δ</th></tr></thead>
          <tbody>${wa.map(w=>`<tr>
              <td class="py-1">${w.pos}</td><td class="py-1">${w.add.name}</td>
              <td class="py-1 text-right">${w.add.proj.toFixed(1)}</td><td class="py-1">${w.drop.name}</td>
              <td class="py-1 text-right">${w.drop.proj.toFixed(1)}</td><td class="py-1 text-right">${w.delta.toFixed(1)}</td>
            </tr>`).join('')}</tbody></table>`
        : "<p class='text-sm text-slate-500'>No clear upgrades found.</p>";
    });

    function toggleTrade(show=true){ const m=document.getElementById('tradeModal'); m.classList.toggle('hidden', !show); m.classList.toggle('flex', show); }
    document.getElementById('btnTrade').addEventListener('click', ()=>toggleTrade(true));
    window.runTrade = function(){
      const giveStr = document.getElementById('tradeGive').value||"";
      const getStr = document.getElementById('tradeGet').value||"";
      const give = giveStr.split(',').map(s=>s.trim()).filter(Boolean);
      const gett = getStr.split(',').map(s=>s.trim()).filter(Boolean);
      if (!give.length && !gett.length) { document.getElementById('tradeOut').textContent="Enter players to compare."; return; }
      const slots = readSlots(); const { starters } = optimizeLineup(roster, slots);
      const res = tradeCompare(roster.concat(freeAgents), starters, give, gett);
      document.getElementById('tradeOut').textContent = JSON.stringify(res, null, 2);
    };

    document.getElementById('btnExportReport').addEventListener('click', ()=>{
      const slots = readSlots();
      const week = new Date().toISOString().slice(0,10);
      const { starters, bench } = optimizeLineup(roster, slots);
      const wa = freeAgents.length ? suggestWaivers(freeAgents, starters, 0.5, 5) : [];
      let md = `# Weekly Report – ${week}\\n\\n`;
      md += `## Optimal Lineup\\n`; starters.forEach(s=>{ md += `- **${s.slot}**: ${s.name} (${s.pos}) — ${s.proj.toFixed(1)} proj\\n`; });
      md += `\\n## Bench Notes\\n`; bench.slice(0,40).forEach(b=>{ md += `- ${b.name} (${b.pos}) — ${b.proj.toFixed(1)} proj\\n`; });
      if (wa.length){ md += `\\n## Top Waiver Adds\\n`; wa.forEach(w=>{ md += `- ${w.pos} — **Add ${w.add.name} (${w.add.proj.toFixed(1)})**, drop ${w.drop.name} (${w.drop.proj.toFixed(1)})  ↑ +${w.delta.toFixed(1)}\\n`; }); }
      const blob = new Blob([md], {type:"text/markdown"}); const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `weekly_report_${week}.md`; a.click(); URL.revokeObjectURL(url);
    });

    render();
  </script>
</body>
</html>
